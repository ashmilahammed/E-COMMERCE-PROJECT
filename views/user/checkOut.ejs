<%- include("../../views/partials/user/header") %>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Include Bootstrap JS and Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>


    <!-- <style>
        /* Modal Background */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            overflow-y: auto;
        }

        /* Modal Content */
        .modal-content {
            background: #fff;
            width: 100%;
            max-width: 500px;
            margin: 40px auto;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        /* Close Button */
        .close-btn {
            position: absolute;
            right: 20px;
            top: 15px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            color: #666;
            transition: color 0.3s;
        }

        .close-btn:hover {
            color: #000;
        }

        /* Form Title */
        .modal-title {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        /* Form Group */
        .form-group {
            margin-bottom: 20px;
        }

        /* Input Fields */
        .modal-content input {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .modal-content input:focus {
            outline: none;
            border-color: #4A90E2;
            box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.1);
        }

        .modal-content input::placeholder {
            color: #999;
        }

        /* Save Button */
        .save-btn {
            width: 100%;
            padding: 12px;
            background: #4A90E2;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 10px;
        }

        .save-btn:hover {
            background: #357ABD;
        }

        .save-btn:active {
            transform: translateY(1px);
        }

        /* Modal Background */
        .addModal {
            display: none;
            position: fixed;
            z-index: 1000;
            /* Ensures the modal is above other content */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            /* Semi-transparent black background */
            justify-content: center;
            align-items: center;
            /* Centers the modal vertically and horizontally */
            padding: 20px;
            overflow-y: auto;
        }

        /* Modal Content */
        .addModal .modal-content {
            background: #fff;
            width: 100%;
            max-width: 500px;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            position: relative;
            animation: fadeIn 0.3s ease-in-out;
        }

        /* Close Button */
        .addModal .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #333;
        }

        .addModal .close-btn:hover {
            color: #000;
        }

        /* Modal Title */
        .addModal .modal-title {
            text-align: center;
            font-size: 22px;
            margin-bottom: 20px;
            font-weight: bold;
            color: #333;
        }

        /* Form Group */
        .addModal .form-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* Input Fields */
        .addModal .form-group input {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s ease-in-out;
        }

        .addModal .form-group input:focus {
            border-color: #007bff;
            outline: none;
        }

        /* Save Button */
        .addModal .save-btn {
            width: 100%;
            background: #007bff;
            color: #fff;
            padding: 12px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            margin-top: 15px;
            cursor: pointer;
            transition: background 0.3s ease-in-out;
        }

        .addModal .save-btn:hover {
            background: #0056b3;
        }

        .addModal .save-btn:active {
            transform: translateY(1px);
        }

        /* Fade-in Animation */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Responsive Design */
        @media (max-width: 600px) {
            .addModal .modal-content {
                width: 95%;
                padding: 15px;
            }

            .addModal .modal-title {
                font-size: 18px;
            }

            .addModal .form-group input {
                font-size: 14px;
                padding: 8px;
            }

            .addModal .save-btn {
                font-size: 14px;
                padding: 10px;
            }

        }

        /* Fix header and body overflow */
        body {
            overflow-x: hidden;
            width: 100%;
            position: relative;
        }

        .header {
            width: 100%;
            overflow: visible;
            position: relative;
            z-index: 1000;
        }

        .header__top {
            padding: 10px 0;
        }

        .header__menu {
            padding: 10px 0;
        }

        .header__menu ul {
            margin: 0;
            padding: 15px 164px;
            display: flex;
            flex-wrap: wrap;
        }

        .header__menu ul li {
            margin-right: 15px;
        }

        /* Fix container overflow */
        .container {
            max-width: 100%;
            padding-right: 15px;
            padding-left: 15px;
            margin-right: auto;
            margin-left: auto;
        }

        @media (min-width: 1200px) {
            .container {
                max-width: 1140px;
            }
        }

        /* Fix checkout page specific issues */
        .checkout__form {
            padding: 20px 0;
            overflow: hidden;
        }

        .shipping-address-section,
        .additional-info,
        .checkout__order {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            overflow: hidden;
        }

        /* Fix table overflow */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Fix footer */
        .footer {
            width: 100%;
            overflow: hidden;
            position: relative;
        }

        /* Fix modal */
        .modal {
            overflow-y: auto;
        }

        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
        }

        /* Responsive fixes */
        @media (max-width: 768px) {
            .header__menu {
                padding: 5px 0;
            }

            .header__menu ul li {
                margin-right: 10px;
            }

            .checkout__form {
                padding: 10px 0;
            }

            .shipping-address-section,
            .additional-info,
            .checkout__order {
                margin-bottom: 15px;
            }
        }
    </style> -->


    <section class="breadcrumb-option">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="breadcrumb__text">
                        <h4>Check Out</h4>
                        <div class="breadcrumb__links">
                            <a href="/">Home</a>
                            <a href="/shop">Shop</a>
                            <span>Check Out</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- Breadcrumb Section End -->

    <!-- Checkout Section Begin -->
    <section class="checkout spad">
        <div class="container">
            <div class="checkout__form">
                <form action="/checkout" method="POST" onsubmit="return false">
                    <div class="row">
                        <div class="col-lg-7 col-md-6">
                            <div class="shipping-address-section p-4 bg-light rounded mb-4" style="min-height: 800px;">
                                <h6 class="checkout__title mb-4">
                                    <i class="fas fa-shipping-fast me-2"></i>Shipping Address
                                </h6>
                                <div class="saved-addresses mb-4">
                                    <% if (addresses && addresses.length> 0) { %>
                                        <div class="row">
                                            <% addresses.forEach((addressDoc, index)=> {
                                                addressDoc.address.forEach((address, addressIndex) => { %>
                                                <div class="col-md-6 mb-3">
                                                    <div class="saved-address-item mb-4 p-4 border rounded bg-white">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="radio"
                                                                name="shipping_address"
                                                                id="address_<%= addressDoc._id %>_<%= addressIndex %>"
                                                                value="<%= address._id %>" <%=(index===0 &&
                                                                addressIndex===0) ? 'checked' : '' %>
                                                            >
                                                            <label class="form-check-label w-100"
                                                                for="address_<%= addressDoc._id %>_<%= addressIndex %>">
                                                                <div
                                                                    class="d-flex justify-content-between align-items-start">
                                                                    <div>
                                                                        <strong class="d-block mb-2">
                                                                            <i class="fas fa-map-marker-alt me-2"></i>
                                                                            <%= address.addressType %>
                                                                        </strong>
                                                                        <div class="address-details ms-4">
                                                                            <p class="mb-2 text-dark">
                                                                                <%= address.name %>
                                                                            </p>
                                                                            <p class="mb-2 text-muted">
                                                                                <%= address.landMark %>,
                                                                                    <%= address.city %>,
                                                                                        <%= address.state %> -
                                                                                            <%= address.pincode %>
                                                                            </p>
                                                                            <p class="mb-1">
                                                                                <i class="fas fa-phone-alt me-2"></i>
                                                                                <span class="text-dark">
                                                                                    <%= address.phone %>
                                                                                </span>
                                                                            </p>
                                                                            <% if (address.altPhone) { %>
                                                                                <p class="mb-0">
                                                                                    <i class="fas fa-phone me-2"></i>
                                                                                    <span class="text-muted">
                                                                                        <%= address.altPhone %>
                                                                                    </span>
                                                                                </p>
                                                                                <% } %>
                                                                        </div>
                                                                    </div>
                                                                    <button type="button" class="btn btn-outline-dark"
                                                                        onclick="openEditAddressModal('<%= JSON.stringify(address) %>')">
                                                                        <i class="fas fa-edit me-2"></i>Edit
                                                                    </button>
                                                                </div>
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                                <% }); %>
                                                    <% }); %>
                                        </div>
                                        <% } else { %>
                                            <div class="text-center py-4">
                                                <p class="mb-3">You haven't added any addresses yet.</p>
                                                <button type="button" onclick="openAddAddressModal()"
                                                    class="btn btn-dark d-block w-100">
                                                    <i class="fas fa-plus-circle me-2"></i>Add Your First Address
                                                </button>
                                            </div>
                                            <% } %>
                                </div>

                                <button type="button" onclick="openAddAddressModal()"
                                    class="btn btn-dark d-block w-100">
                                    <i class="fas fa-plus-circle me-2"></i>Add Another Address
                                </button>

                            </div>
                            <div class="additional-info p-4 border rounded bg-white">
                                <h6 class="checkout__title mb-4">
                                    <i class="fas fa-info-circle me-2"></i>Additional Information
                                </h6>
                                <div class="checkout__input">
                                    <p>Order Notes (Optional)</p>
                                    <input type="text" class="w-100 p-3" rows="4"
                                        style="resize: none; border: 1px solid #e1e1e1; border-radius: 4px;"
                                        placeholder="Special notes for delivery (e.g., delivery timing, specific instructions for delivery)">
                                    </input>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-5 col-md-6">
                            <div class="checkout__order p-4" style="min-height: 800px;">
                                <h4 class="order__title mb-4">
                                    <i class="fas fa-shopping-cart me-2"></i>Your Order
                                </h4>


                                <!-- ////////////////////////////////////////////////////////////////////////////////////////       -->


                                <!-- Product Details Section -->
                                <div class="checkout__order__products p-4 border rounded bg-white mb-4">
                                    <h6 class="mb-4">
                                        <i class="fas fa-box me-2"></i>Products in Checkout
                                    </h6>
                                    <% if (cart && cart.items && cart.items.length> 0) { %>
                                        <% cart.items.forEach(function(item) { %>
                                            <div class="product-item d-flex align-items-center mb-3 pb-3 border-bottom">
                                                <div class="product-image me-3">
                                                    <img src="/uploads/re-image/<%= item.productId.productImage[0] %>"
                                                        alt="<%= item.productId.productName %>" class="img-fluid"
                                                        style="max-width: 100px; max-height: 100px;">
                                                </div>
                                                <div class="product-details flex-grow-1">
                                                    <h6 class="mb-1">
                                                        <%= item.productId.productName %>
                                                    </h6>
                                                    <p class="text-muted mb-1">Size: <%= item.size %> | Quantity: <%=
                                                                item.quantity %>
                                                    </p>
                                                    <p class="fw-bold">
                                                        Item Total: ₹<%= (item.productId.variants.find(v=> v.size ===
                                                            item.size).salePrice * item.quantity).toFixed(2) %>
                                                    </p>
                                                </div>
                                            </div>
                                            <% }); %>
                                                <% } else { %>
                                                    <p class="text-center text-muted">No products in checkout</p>
                                                    <% } %>
                                </div>



                                <!-- Coupon Code Section -->
                                <div class="checkout__coupon mb-4 p-3 border rounded bg-white">
                                    <h6 class="mb-3">
                                        <i class="fas fa-tag me-2"></i>Have a Coupon?
                                    </h6>
                                    <div class="input-group">
                                        <input type="text" class="form-control" placeholder="Enter Coupon Code">
                                        <button class="site-btn">Apply</button>
                                    </div>
                                </div>

                                <!-- Order Summary with Taxes and Discounts -->
                                <div class="checkout__order__summary p-4 border rounded bg-white">
                                    <h6 class="mb-4">
                                        <i class="fas fa-receipt me-2"></i>Order Summary
                                    </h6>
                                    <div class="summary-details">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>Subtotal</span>
                                            <span>₹<%= cart.subtotal.toFixed(2) %></span>
                                        </div>

                                        <div class="d-flex justify-content-between mb-2">
                                            <span>Taxes</span>
                                            <span>₹<%= cart.tax.toFixed(2) %></span>
                                        </div>

                                        <div class="d-flex justify-content-between mb-2">
                                            <span>Shipping</span>
                                            <span>₹<%= cart.shipping.toFixed(2) %></span>
                                        </div>
                                        <li class="d-flex justify-content-between mb-2 text-success">
                                            Discount <span>-₹0</span>
                                        </li>
                                        <hr>
                                        <div class="d-flex justify-content-between fw-bold">
                                            <span>Total</span>
                                            <span>₹<%= cart.total.toFixed(2) %></span>
                                        </div>
                                    </div>
                                </div>



                                <!-- Payment Methods -->
                                <div class="checkout_payment_methods p-4 border rounded bg-white">
                                    <h6 class="mb-4">
                                        <i class="fas fa-credit-card me-2"></i>Select Payment Method
                                    </h6>
                                    <div class="payment-method">
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="radio" name="payment_method"
                                                value="cod" id="cod" checked>
                                            <label class="form-check-label d-flex align-items-center" for="cod">
                                                <i class="fas fa-money-bill-wave me-2"></i>
                                                <span>Cash on Delivery</span>
                                                <span class="badge bg-success ms-2">No additional charges</span>
                                            </label>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="radio" value="wallet"
                                                name="payment_method" id="wallet">
                                            <label class="form-check-label" for="wallet">
                                                <i class="fas fa-wallet me-2"></i>Wallet
                                            </label>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="radio" value="upi"
                                                name="payment_method" id="upi">
                                            <label class="form-check-label" for="upi">
                                                <i class="fas fa-mobile-alt me-2"></i>UPI
                                            </label>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="radio" value="credit_card"
                                                name="payment_method" id="card">
                                            <label class="form-check-label" for="card">
                                                <i class="fas fa-credit-card me-2"></i>Credit/Debit Card
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- Place Order Button -->
                                <button id="placeOrderBtn" type="submit" class="site-btn w-100 mt-4">
                                    <i class="fas fa-check-circle me-2"></i>PLACE ORDER
                                </button>


                            </div>

                        </div>

                    </div>

                </form>

            </div>
        </div>
    </section>

    <!-- Add Address Modal -->
    <div class="modal fade" id="addAddressModal" tabindex="-1" aria-labelledby="addAddressModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addAddressModalLabel">Add New Address</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addAddressForm">
                        <div class="mb-3">
                            <label for="fullName" class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="fullName" name="fullName" required>
                        </div>
                        <div class="mb-3">
                            <label for="mobileNumber" class="form-label">Mobile Number</label>
                            <input type="tel" class="form-control" id="mobileNumber" name="mobileNumber" required>
                        </div>
                        <div class="mb-3">
                            <label for="pincode" class="form-label">Pincode</label>
                            <input type="text" class="form-control" id="pincode" name="pincode" required>
                        </div>
                        <div class="mb-3">
                            <label for="locality" class="form-label">Locality</label>
                            <input type="text" class="form-control" id="locality" name="locality" required>
                        </div>
                        <div class="mb-3">
                            <label for="address" class="form-label">Address</label>
                            <textarea class="form-control" id="address" name="address" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="city" class="form-label">City/District/Town</label>
                            <input type="text" class="form-control" id="city" name="city" required>
                        </div>
                        <div class="mb-3">
                            <label for="state" class="form-label">State</label>
                            <input type="text" class="form-control" id="state" name="state" required>
                        </div>
                        <div class="mb-3">
                            <label for="addressType" class="form-label">Address Type</label>
                            <select class="form-select" id="addressType" name="addressType" required>
                                <option value="home">Home</option>
                                <option value="work">Work</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="saveAddress()">Save Address</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Address Modal -->
    <div class="modal fade" id="editAddressModal" tabindex="-1" aria-labelledby="editAddressModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editAddressModalLabel">Edit Address</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editAddressForm">
                        <input type="hidden" id="editAddressId" name="addressId">
                        <div class="mb-3">
                            <label for="editFullName" class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="editFullName" name="fullName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editMobileNumber" class="form-label">Mobile Number</label>
                            <input type="tel" class="form-control" id="editMobileNumber" name="mobileNumber" required>
                        </div>
                        <div class="mb-3">
                            <label for="editPincode" class="form-label">Pincode</label>
                            <input type="text" class="form-control" id="editPincode" name="pincode" required>
                        </div>
                        <div class="mb-3">
                            <label for="editLocality" class="form-label">Locality</label>
                            <input type="text" class="form-control" id="editLocality" name="locality" required>
                        </div>
                        <div class="mb-3">
                            <label for="editAddress" class="form-label">Address</label>
                            <textarea class="form-control" id="editAddress" name="address" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="editCity" class="form-label">City/District/Town</label>
                            <input type="text" class="form-control" id="editCity" name="city" required>
                        </div>
                        <div class="mb-3">
                            <label for="editState" class="form-label">State</label>
                            <input type="text" class="form-control" id="editState" name="state" required>
                        </div>
                        <div class="mb-3">
                            <label for="editAddressType" class="form-label">Address Type</label>
                            <select class="form-select" id="editAddressType" name="addressType" required>
                                <option value="home">Home</option>
                                <option value="work">Work</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="updateAddress()">Update Address</button>
                </div>
            </div>
        </div>
    </div>

    <%- include("../../views/partials/user/footer") %>

        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

        <script>
            function openAddAddressModal(addressData) {
                if (typeof addressData === 'string') {
                    addressData = JSON.parse(addressData);
                }
                const modal = new bootstrap.Modal(document.getElementById('addAddressModal'));
                modal.show();
            }

            function openEditAddressModal(addressData) {
                const modal = new bootstrap.Modal(document.getElementById('editAddressModal'));
                // Fill the form with existing address data
                document.getElementById('editAddressId').value = addressData._id;
                document.getElementById('editFullName').value = addressData.fullName;
                document.getElementById('editMobileNumber').value = addressData.mobileNumber;
                document.getElementById('editPincode').value = addressData.pincode;
                document.getElementById('editLocality').value = addressData.locality;
                document.getElementById('editAddress').value = addressData.address;
                document.getElementById('editCity').value = addressData.city;
                document.getElementById('editState').value = addressData.state;
                document.getElementById('editAddressType').value = addressData.addressType;
                modal.show();
            }

            async function saveAddress() {
                const formData = new FormData(document.getElementById('addAddressForm'));
                const addressData = Object.fromEntries(formData.entries());

                try {
                    const response = await fetch('/add-address', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(addressData)
                    });

                    if (response.ok) {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('addAddressModal'));
                        modal.hide();
                        // Reload the page to show the new address
                        window.location.reload();
                    } else {
                        throw new Error('Failed to add address');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'Failed to add address. Please try again.'
                    });
                }
            }

            async function updateAddress() {
                const formData = new FormData(document.getElementById('editAddressForm'));
                const addressData = Object.fromEntries(formData.entries());

                try {
                    const response = await fetch('/update-address', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(addressData)
                    });

                    if (response.ok) {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('editAddressModal'));
                        modal.hide();
                        // Reload the page to show the updated address
                        window.location.reload();
                    } else {
                        throw new Error('Failed to update address');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'Failed to update address. Please try again.'
                    });
                }
            }

            function sanitizeQuotes(str) {
                return str.replace(/'/g, "\\'").replace(/"/g, '\\"');
            }

            document.addEventListener("DOMContentLoaded", function () {
                const placeOrderBtn = document.getElementById("placeOrderBtn");
                if (placeOrderBtn) {
                    placeOrderBtn.addEventListener("click", async function (e) {
                        e.preventDefault();
                        // alert("button clicked");
                        await placeOrder();
                    });
                }
            });



            async function placeOrder() {
                try {
                    // Get all required order details
                    const shippingAddress = document.querySelector('input[name="shipping_address"]:checked').value;
                    const paymentMethod = document.querySelector('input[name="payment_method"]:checked').value;
                    const totalAmount = document.getElementById('total-amount').textContent.replace('₹', '');
                    const sanitizedOrderItems = sanitizeQuotes(JSON.stringify(cart.items))
                    const orderedItems = sanitizedOrderItems
                    console.log('Order Details:', {
                        shippingAddress,
                        paymentMethod,
                        totalAmount,
                        orderedItems
                    });
                    // First SweetAlert - Confirmation
                    const confirmResult = await Swal.fire({
                        title: 'Confirm Order',
                        text: 'Are you sure you want to place this order?',
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Yes, place order!',
                        cancelButtonText: 'No, cancel'
                    });

                    if (confirmResult.isConfirmed) {
                        // Show loading state
                        Swal.fire({
                            title: 'Processing',
                            text: 'Please wait while we process your order...',
                            allowOutsideClick: false,
                            allowEscapeKey: false,
                            showConfirmButton: false,
                            didOpen: () => {
                                Swal.showLoading();
                            }
                        });

                        // Make the API call with all order details
                        const response = await fetch("/checkout", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({
                                shippingAddress,
                                paymentMethod,
                                totalAmount,
                                orderedItems
                            })
                        });

                        const data = await response.json();

                        if (data.success) {
                            // Success message
                            await Swal.fire({
                                title: 'Success!',
                                text: 'Your order has been placed successfully!',
                                icon: 'success',
                                timer: 1500,
                                showConfirmButton: false
                            });

                            // Redirect to orders page after success
                            window.location.href = "/viewOrder";
                            // window.location.replace("/viewOrder/${data.orderId}");
                        } else {
                            throw new Error(data.message || 'Order failed');
                        }
                    }
                } catch (error) {
                    console.error('Error:', error.message);
                    await Swal.fire({
                        title: 'Error!',
                        text: 'Something went wrong while placing your order. Please try again.',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                }
            }
        </script>